//! Panel render functions for ChatView
//!
//! This module contains all the panel/modal overlay render functions.
//! Extracted from core.rs for better organization.
//!
//! Panels included:
//! - Suggestions bar
//! - Quick templates bar
//! - Session history panel
//! - Error retry bar
//! - Permissions panel
//! - MCP servers panel
//! - Commands panel
//! - Templates panel
//! - Context panel
//! - Export panel
//! - Notes panel
//! - Favorites panel
//! - Recent files panel
//! - Pinned panel
//! - Statistics panel
//! - Quick settings panel
//! - Tags editor panel
//! - Tasks panel
//! - Git panel
//! - File picker
//! - Session details

use gpui::*;
use gpui::prelude::*;

use crate::ui::pct;
use super::core::{ChatView, CommandCategory, ErrorCategory, ExportFormat, NotificationType};

/// Panel render implementations for ChatView
impl ChatView {
    // ==================== Render: Suggestions Bar ====================

    /// Render contextual suggestions bar
    pub fn render_suggestions_bar(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> Div {
        let suggestions: Vec<_> = self.contextual_suggestions.iter().enumerate().collect();

        div()
            .w_full()
            .px_4()
            .py_2()
            .border_t_1()
            .border_color(theme.colors.border)
            .bg(theme.colors.surface.opacity(0.5))
            .flex()
            .items_center()
            .gap_2()
            // Header
            .child(
                div()
                    .flex()
                    .items_center()
                    .gap_1()
                    .text_xs()
                    .text_color(theme.colors.text_muted)
                    .child("üí°")
                    .child("Suggestions:")
            )
            // Suggestion chips
            .children(suggestions.into_iter().map(|(idx, suggestion)| {
                let text = suggestion.text.clone();
                div()
                    .id(SharedString::from(format!("suggestion-{}", idx)))
                    .flex()
                    .items_center()
                    .gap_1()
                    .px_2()
                    .py_1()
                    .rounded_md()
                    .bg(theme.colors.accent.opacity(0.1))
                    .border_1()
                    .border_color(theme.colors.accent.opacity(0.2))
                    .cursor_pointer()
                    .text_xs()
                    .text_color(theme.colors.text)
                    .hover(|s| {
                        s.bg(theme.colors.accent.opacity(0.2))
                            .border_color(theme.colors.accent.opacity(0.4))
                    })
                    .on_click(cx.listener(move |this, _, _window, cx| {
                        this.use_suggestion(idx, cx);
                    }))
                    .child(suggestion.icon)
                    .child(text)
            }))
            // Toggle button
            .child(
                div()
                    .ml_auto()
                    .id("toggle-suggestions")
                    .px_2()
                    .py_1()
                    .rounded_md()
                    .cursor_pointer()
                    .text_xs()
                    .text_color(theme.colors.text_muted)
                    .hover(|s| s.bg(theme.colors.surface_hover))
                    .on_click(cx.listener(|this, _, _window, cx| {
                        this.toggle_suggestions(cx);
                    }))
                    .child("Hide")
            )
    }

    // ==================== Render: Quick Templates Bar ====================

    /// Render quick access templates bar (shows top 5 most used templates)
    pub fn render_quick_templates_bar(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        // Get top 5 most used templates (sorted by usage count)
        let mut templates: Vec<_> = self.prompt_templates.iter()
            .filter(|t| t.usage_count > 0 || t.is_builtin)
            .collect();
        templates.sort_by(|a, b| b.usage_count.cmp(&a.usage_count));
        let top_templates: Vec<_> = templates.into_iter().take(5).collect();

        div()
            .id("quick-templates-bar")
            .w_full()
            .px_4()
            .py_1()
            .border_t_1()
            .border_color(theme.colors.border.opacity(0.5))
            .bg(theme.colors.surface.opacity(0.3))
            .flex()
            .items_center()
            .gap_2()
            .overflow_x_scroll()
            // Header
            .child(
                div()
                    .flex()
                    .items_center()
                    .gap_1()
                    .text_xs()
                    .text_color(theme.colors.text_muted)
                    .flex_shrink_0()
                    .child("üìù")
                    .child("Quick:")
            )
            // Template chips
            .children(top_templates.into_iter().map(|template| {
                let template_id = template.id.clone();
                div()
                    .id(ElementId::Name(format!("quick-template-{}", template.id).into()))
                    .flex()
                    .items_center()
                    .gap_1()
                    .px_2()
                    .py(px(3.0))
                    .rounded_md()
                    .bg(theme.colors.background)
                    .border_1()
                    .border_color(theme.colors.border.opacity(0.5))
                    .cursor_pointer()
                    .text_xs()
                    .text_color(theme.colors.text)
                    .flex_shrink_0()
                    .hover(|s| {
                        s.bg(theme.colors.accent.opacity(0.1))
                            .border_color(theme.colors.accent.opacity(0.3))
                    })
                    .on_click(cx.listener(move |this, _, _window, cx| {
                        this.use_template(&template_id, cx);
                    }))
                    .child(template.icon)
                    .child(template.name.clone())
            }))
            // Spacer
            .child(div().flex_1())
            // Open all templates button
            .child(
                div()
                    .id("open-all-templates")
                    .flex()
                    .items_center()
                    .gap_1()
                    .px_2()
                    .py(px(3.0))
                    .rounded_md()
                    .cursor_pointer()
                    .text_xs()
                    .text_color(theme.colors.accent)
                    .flex_shrink_0()
                    .hover(|s| s.bg(theme.colors.accent.opacity(0.1)))
                    .on_click(cx.listener(|this, _, _window, cx| {
                        this.toggle_templates_panel(cx);
                    }))
                    .child("All templates")
                    .child("‚Üí")
            )
    }

    // ==================== Render: Error Retry Bar ====================

    /// Handle error suggestion action
    pub fn handle_error_suggestion(&mut self, action: &str, cx: &mut Context<Self>) {
        match action {
            "retry" => self.retry_last_request(cx),
            "wait_retry" => {
                // Show notification and schedule retry
                self.show_notification("Waiting before retry...", NotificationType::Info, cx);
                self.retry_last_request(cx);
            }
            "check_connection" => {
                self.send_slash_command("/doctor", cx);
            }
            "new_conversation" => {
                self.clear_conversation(cx);
            }
            "show_details" => {
                // Toggle expanded error details
                if let Some(ref error) = self.last_error {
                    self.show_notification(&format!("Error details: {}", error.message), NotificationType::Error, cx);
                }
            }
            cmd if cmd.starts_with('/') => {
                self.send_slash_command(cmd, cx);
            }
            _ => {}
        }
    }

    /// Get error title based on category
    pub fn get_error_title(category: ErrorCategory) -> &'static str {
        match category {
            ErrorCategory::Network => "Connection Issue",
            ErrorCategory::RateLimit => "Rate Limited",
            ErrorCategory::ContextOverflow => "Context Too Large",
            ErrorCategory::Auth => "Authentication Error",
            ErrorCategory::ToolError => "Tool Execution Failed",
            ErrorCategory::General => "Operation Failed",
        }
    }

    /// Render error retry bar with smart suggestions
    pub fn render_error_retry_bar(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> Div {
        let error = self.last_error.as_ref().unwrap();
        let suggestions = error.category.suggestions();
        let category_icon = error.category.icon();
        let error_title = Self::get_error_title(error.category);

        div()
            .w_full()
            .px_4()
            .py_3()
            .border_t_1()
            .border_color(theme.colors.error.opacity(0.3))
            .bg(theme.colors.error.opacity(0.05))
            .flex()
            .flex_col()
            .gap_2()
            // Main error row
            .child(
                div()
                    .flex()
                    .items_center()
                    .gap_3()
                    // Error icon (category-specific)
                    .child(
                        div()
                            .size(px(32.0))
                            .rounded_md()
                            .bg(theme.colors.error.opacity(0.1))
                            .flex()
                            .items_center()
                            .justify_center()
                            .text_base()
                            .child(category_icon)
                    )
                    // Error message
                    .child(
                        div()
                            .flex_1()
                            .flex()
                            .flex_col()
                            .gap(px(2.0))
                            .child(
                                div()
                                    .text_xs()
                                    .font_weight(FontWeight::SEMIBOLD)
                                    .text_color(theme.colors.error)
                                    .child(error_title)
                            )
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .max_w(px(500.0))
                                    .overflow_x_hidden()
                                    .child(error.message.clone())
                            )
                    )
                    // Dismiss button
                    .child(
                        div()
                            .id("dismiss-error")
                            .size(px(24.0))
                            .rounded_md()
                            .cursor_pointer()
                            .flex()
                            .items_center()
                            .justify_center()
                            .text_xs()
                            .text_color(theme.colors.text_muted)
                            .hover(|s| s.bg(theme.colors.surface_hover).text_color(theme.colors.text))
                            .on_click(cx.listener(|this, _, _window, cx| {
                                this.clear_error(cx);
                            }))
                            .child("√ó")
                    )
            )
            // Smart suggestions row
            .child(
                div()
                    .flex()
                    .items_center()
                    .gap_2()
                    .pl(px(44.0)) // Align with error text
                    .child(
                        div()
                            .text_xs()
                            .text_color(theme.colors.text_muted)
                            .child("Try:")
                    )
                    .children(suggestions.iter().enumerate().map(|(idx, (icon, label, action))| {
                        let action_str = action.to_string();
                        let is_primary = idx == 0;

                        div()
                            .id(SharedString::from(format!("error-suggestion-{}", idx)))
                            .flex()
                            .items_center()
                            .gap_1()
                            .px_2()
                            .py_1()
                            .rounded_md()
                            .cursor_pointer()
                            .text_xs()
                            .when(is_primary, |d| {
                                d.bg(theme.colors.warning.opacity(0.15))
                                    .border_1()
                                    .border_color(theme.colors.warning.opacity(0.3))
                                    .text_color(theme.colors.warning)
                                    .font_weight(FontWeight::MEDIUM)
                            })
                            .when(!is_primary, |d| {
                                d.bg(theme.colors.surface)
                                    .border_1()
                                    .border_color(theme.colors.border)
                                    .text_color(theme.colors.text_muted)
                            })
                            .hover(|s| {
                                s.bg(theme.colors.surface_hover)
                                    .border_color(theme.colors.accent.opacity(0.5))
                            })
                            .on_click(cx.listener(move |this, _, _window, cx| {
                                this.handle_error_suggestion(&action_str, cx);
                            }))
                            .child(*icon)
                            .child(*label)
                    }))
            )
    }

    // ==================== Render: Detail Row Helpers ====================

    /// Render a detail row (label: value)
    pub fn render_detail_row(&self, label: &str, value: &str, theme: &crate::app::theme::Theme) -> Div {
        div()
            .flex()
            .items_center()
            .justify_between()
            .child(
                div()
                    .text_xs()
                    .text_color(theme.colors.text_muted)
                    .child(label.to_string())
            )
            .child(
                div()
                    .text_xs()
                    .font_family("monospace")
                    .text_color(theme.colors.text)
                    .child(value.to_string())
            )
    }

    /// Render a detail row with a copy button
    pub fn render_detail_row_with_copy(&self, label: &str, value: &str, id_suffix: &str, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> Div {
        let value_to_copy = value.to_string();
        div()
            .flex()
            .items_center()
            .justify_between()
            .child(
                div()
                    .text_xs()
                    .text_color(theme.colors.text_muted)
                    .child(label.to_string())
            )
            .child(
                div()
                    .flex()
                    .items_center()
                    .gap_2()
                    .child(
                        div()
                            .text_xs()
                            .font_family("monospace")
                            .text_color(theme.colors.text)
                            .max_w(px(200.0))
                            .overflow_hidden()
                            .child(value.to_string())
                    )
                    .child(
                        div()
                            .id(ElementId::Name(format!("copy-{}", id_suffix).into()))
                            .w(px(18.0))
                            .h(px(18.0))
                            .flex()
                            .items_center()
                            .justify_center()
                            .rounded_sm()
                            .cursor_pointer()
                            .text_xs()
                            .text_color(theme.colors.text_muted)
                            .hover(|s| s.bg(theme.colors.surface_hover).text_color(theme.colors.text))
                            .on_click(cx.listener(move |_this, _, _window, cx| {
                                cx.write_to_clipboard(gpui::ClipboardItem::new_string(value_to_copy.clone()));
                            }))
                            .child("üìã")
                    )
            )
    }

    // ==================== Render: Session History Panel ====================

    /// Render session history panel (overlay)
    pub fn render_session_history_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let sessions: Vec<_> = self.recent_sessions.iter().enumerate().collect();

        // Full-screen overlay
        div()
            .id("session-history-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.5))
            // Click outside to close
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_session_history(cx);
            }))
            .child(
                // Panel
                div()
                    .id("session-history-panel")
                    .w(px(500.0))
                    .max_h(px(500.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.border)
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    // Prevent clicks from propagating
                    .on_click(|_, _, _| {})
                    // Header
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(
                                        div()
                                            .text_base()
                                            .child("üìã")
                                    )
                                    .child(
                                        div()
                                            .text_sm()
                                            .font_weight(FontWeight::SEMIBOLD)
                                            .text_color(theme.colors.text)
                                            .child("Recent Sessions")
                                    )
                            )
                            .child(
                                div()
                                    .id("close-session-history")
                                    .px_2()
                                    .py_1()
                                    .rounded_md()
                                    .cursor_pointer()
                                    .text_sm()
                                    .text_color(theme.colors.text_muted)
                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        this.toggle_session_history(cx);
                                    }))
                                    .child("√ó")
                            )
                    )
                    // Sessions list
                    .child(
                        div()
                            .id("session-list")
                            .flex_1()
                            .overflow_y_scroll()
                            .when(sessions.is_empty(), |d| {
                                d.child(
                                    div()
                                        .px_4()
                                        .py_8()
                                        .text_center()
                                        .text_sm()
                                        .text_color(theme.colors.text_muted)
                                        .child("No recent sessions")
                                )
                            })
                            .children(sessions.into_iter().map(|(idx, session)| {
                                let session_id = session.session_id.clone();
                                let elapsed = chrono::Utc::now().signed_duration_since(session.last_active);
                                let time_str = if elapsed.num_hours() < 1 {
                                    format!("{} min ago", elapsed.num_minutes())
                                } else if elapsed.num_hours() < 24 {
                                    format!("{} hr ago", elapsed.num_hours())
                                } else {
                                    format!("{} days ago", elapsed.num_days())
                                };

                                div()
                                    .id(SharedString::from(format!("session-{}", idx)))
                                    .px_4()
                                    .py_3()
                                    .border_b_1()
                                    .border_color(theme.colors.border.opacity(0.5))
                                    .cursor_pointer()
                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                    .on_click(cx.listener(move |this, _, _window, cx| {
                                        this.resume_session(&session_id, cx);
                                    }))
                                    .flex()
                                    .flex_col()
                                    .gap_1()
                                    // Title row
                                    .child(
                                        div()
                                            .flex()
                                            .items_center()
                                            .justify_between()
                                            .child(
                                                div()
                                                    .text_sm()
                                                    .font_weight(FontWeight::MEDIUM)
                                                    .text_color(theme.colors.text)
                                                    .child(session.title.clone())
                                            )
                                            .child(
                                                div()
                                                    .text_xs()
                                                    .text_color(theme.colors.text_muted)
                                                    .child(time_str)
                                            )
                                    )
                                    // Info row
                                    .child(
                                        div()
                                            .flex()
                                            .items_center()
                                            .gap_3()
                                            .text_xs()
                                            .text_color(theme.colors.text_muted)
                                            .child(
                                                div()
                                                    .flex()
                                                    .items_center()
                                                    .gap_1()
                                                    .child("üí¨")
                                                    .child(format!("{} messages", session.message_count))
                                            )
                                            .child(
                                                div()
                                                    .flex()
                                                    .items_center()
                                                    .gap_1()
                                                    .child("ü§ñ")
                                                    .child(session.model.clone())
                                            )
                                            .child(
                                                div()
                                                    .flex()
                                                    .items_center()
                                                    .gap_1()
                                                    .child("üìÅ")
                                                    .child(session.cwd.clone())
                                            )
                                    )
                            }))
                    )
                    // Footer
                    .child(
                        div()
                            .px_4()
                            .py_2()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .text_xs()
                            .text_color(theme.colors.text_muted)
                            .child("Click a session to resume")
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_1()
                                    .child(
                                        div()
                                            .px_1()
                                            .rounded_sm()
                                            .bg(theme.colors.background)
                                            .border_1()
                                            .border_color(theme.colors.border)
                                            .font_family("monospace")
                                            .child("‚éã")
                                    )
                                    .child("Close")
                            )
                    )
            )
    }

    // ==================== Render: Permissions Panel ====================

    /// Render permissions panel (overlay)
    pub fn render_permissions_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let permissions: Vec<_> = self.pending_permissions.iter().enumerate().collect();
        let permissions_count = permissions.len();
        let has_multiple = permissions_count > 1;
        let is_empty = permissions_count == 0;

        // Full-screen overlay
        div()
            .id("permissions-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.6))
            // Click outside to close
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_permissions_panel(cx);
            }))
            .child(
                // Panel
                div()
                    .id("permissions-panel")
                    .w(px(450.0))
                    .max_h(px(400.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.warning.opacity(0.5))
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    // Prevent clicks from propagating
                    .on_click(|_, _, _| {})
                    // Header
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .bg(theme.colors.warning.opacity(0.05))
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(
                                        div()
                                            .text_base()
                                            .child("üîê")
                                    )
                                    .child(
                                        div()
                                            .text_sm()
                                            .font_weight(FontWeight::SEMIBOLD)
                                            .text_color(theme.colors.text)
                                            .child("Permission Requests")
                                    )
                                    .child(
                                        div()
                                            .px_2()
                                            .py_px()
                                            .rounded_full()
                                            .bg(theme.colors.warning.opacity(0.2))
                                            .text_xs()
                                            .text_color(theme.colors.warning)
                                            .child(format!("{}", permissions.len()))
                                    )
                            )
                            .child(
                                div()
                                    .id("close-permissions")
                                    .px_2()
                                    .py_1()
                                    .rounded_md()
                                    .cursor_pointer()
                                    .text_sm()
                                    .text_color(theme.colors.text_muted)
                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        this.toggle_permissions_panel(cx);
                                    }))
                                    .child("√ó")
                            )
                    )
                    // Permissions list
                    .child(
                        div()
                            .id("permissions-list")
                            .flex_1()
                            .overflow_y_scroll()
                            .when(permissions.is_empty(), |d| {
                                d.child(
                                    div()
                                        .px_4()
                                        .py_8()
                                        .text_center()
                                        .child(
                                            div()
                                                .text_lg()
                                                .mb_2()
                                                .child("‚úÖ")
                                        )
                                        .child(
                                            div()
                                                .text_sm()
                                                .text_color(theme.colors.text_muted)
                                                .child("No pending permissions")
                                        )
                                )
                            })
                            .children(permissions.into_iter().map(|(idx, permission)| {
                                let risk_color = permission.risk_level.color(theme);

                                div()
                                    .id(SharedString::from(format!("permission-{}", idx)))
                                    .px_4()
                                    .py_3()
                                    .border_b_1()
                                    .border_color(theme.colors.border.opacity(0.5))
                                    .flex()
                                    .flex_col()
                                    .gap_2()
                                    // Tool and risk level
                                    .child(
                                        div()
                                            .flex()
                                            .items_center()
                                            .justify_between()
                                            .child(
                                                div()
                                                    .flex()
                                                    .items_center()
                                                    .gap_2()
                                                    .child(
                                                        div()
                                                            .px_2()
                                                            .py_px()
                                                            .rounded_sm()
                                                            .bg(theme.colors.accent.opacity(0.1))
                                                            .text_xs()
                                                            .font_weight(FontWeight::MEDIUM)
                                                            .text_color(theme.colors.accent)
                                                            .child(permission.tool.clone())
                                                    )
                                            )
                                            .child(
                                                div()
                                                    .flex()
                                                    .items_center()
                                                    .gap_1()
                                                    .px_2()
                                                    .py_px()
                                                    .rounded_sm()
                                                    .bg(risk_color.opacity(0.1))
                                                    .text_xs()
                                                    .text_color(risk_color)
                                                    .child(permission.risk_level.icon())
                                                    .child(permission.risk_level.label())
                                            )
                                    )
                                    // Description
                                    .child(
                                        div()
                                            .text_sm()
                                            .text_color(theme.colors.text)
                                            .child(permission.description.clone())
                                    )
                                    // Action/command
                                    .child(
                                        div()
                                            .px_2()
                                            .py_1()
                                            .rounded_sm()
                                            .bg(theme.colors.background)
                                            .border_1()
                                            .border_color(theme.colors.border)
                                            .text_xs()
                                            .font_family("monospace")
                                            .text_color(theme.colors.text_muted)
                                            .overflow_x_hidden()
                                            .child(permission.action.clone())
                                    )
                                    // Action buttons
                                    .child(
                                        div()
                                            .flex()
                                            .items_center()
                                            .gap_2()
                                            .mt_1()
                                            // Approve button
                                            .child(
                                                div()
                                                    .id(SharedString::from(format!("approve-{}", idx)))
                                                    .flex_1()
                                                    .flex()
                                                    .items_center()
                                                    .justify_center()
                                                    .gap_1()
                                                    .px_3()
                                                    .py(px(6.0))
                                                    .rounded_md()
                                                    .bg(theme.colors.success.opacity(0.1))
                                                    .border_1()
                                                    .border_color(theme.colors.success.opacity(0.3))
                                                    .cursor_pointer()
                                                    .text_xs()
                                                    .font_weight(FontWeight::MEDIUM)
                                                    .text_color(theme.colors.success)
                                                    .hover(|s| {
                                                        s.bg(theme.colors.success.opacity(0.2))
                                                            .border_color(theme.colors.success.opacity(0.5))
                                                    })
                                                    .on_click(cx.listener(move |this, _, _window, cx| {
                                                        this.approve_permission(idx, cx);
                                                    }))
                                                    .child("‚úì")
                                                    .child("Approve")
                                            )
                                            // Deny button
                                            .child(
                                                div()
                                                    .id(SharedString::from(format!("deny-{}", idx)))
                                                    .flex_1()
                                                    .flex()
                                                    .items_center()
                                                    .justify_center()
                                                    .gap_1()
                                                    .px_3()
                                                    .py(px(6.0))
                                                    .rounded_md()
                                                    .bg(theme.colors.error.opacity(0.1))
                                                    .border_1()
                                                    .border_color(theme.colors.error.opacity(0.3))
                                                    .cursor_pointer()
                                                    .text_xs()
                                                    .font_weight(FontWeight::MEDIUM)
                                                    .text_color(theme.colors.error)
                                                    .hover(|s| {
                                                        s.bg(theme.colors.error.opacity(0.2))
                                                            .border_color(theme.colors.error.opacity(0.5))
                                                    })
                                                    .on_click(cx.listener(move |this, _, _window, cx| {
                                                        this.deny_permission(idx, cx);
                                                    }))
                                                    .child("√ó")
                                                    .child("Deny")
                                            )
                                    )
                            }))
                    )
                    // Footer with bulk actions
                    .child(
                        div()
                            .px_4()
                            .py_2()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            // Left side - hint text
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .when(is_empty, |d| d.child("No pending requests"))
                                    .when(!is_empty, |d| {
                                        d.child(
                                            div()
                                                .flex()
                                                .items_center()
                                                .gap_1()
                                                .child("‚å®Ô∏è")
                                                .child("Press A to approve all, D to deny all")
                                        )
                                    })
                            )
                            // Right side - bulk action buttons (when multiple permissions)
                            .when(has_multiple, |d| {
                                d.child(
                                    div()
                                        .flex()
                                        .items_center()
                                        .gap_2()
                                        // Approve All button
                                        .child(
                                            div()
                                                .id("approve-all-perms")
                                                .flex()
                                                .items_center()
                                                .gap_1()
                                                .px_3()
                                                .py(px(4.0))
                                                .rounded_md()
                                                .bg(theme.colors.success.opacity(0.1))
                                                .border_1()
                                                .border_color(theme.colors.success.opacity(0.3))
                                                .cursor_pointer()
                                                .text_xs()
                                                .font_weight(FontWeight::MEDIUM)
                                                .text_color(theme.colors.success)
                                                .hover(|s| {
                                                    s.bg(theme.colors.success.opacity(0.2))
                                                        .border_color(theme.colors.success.opacity(0.5))
                                                })
                                                .on_click(cx.listener(|this, _, _window, cx| {
                                                    this.approve_all_permissions(cx);
                                                }))
                                                .child("‚úì‚úì")
                                                .child("Approve All")
                                        )
                                        // Deny All button
                                        .child(
                                            div()
                                                .id("deny-all-perms")
                                                .flex()
                                                .items_center()
                                                .gap_1()
                                                .px_3()
                                                .py(px(4.0))
                                                .rounded_md()
                                                .bg(theme.colors.error.opacity(0.1))
                                                .border_1()
                                                .border_color(theme.colors.error.opacity(0.3))
                                                .cursor_pointer()
                                                .text_xs()
                                                .font_weight(FontWeight::MEDIUM)
                                                .text_color(theme.colors.error)
                                                .hover(|s| {
                                                    s.bg(theme.colors.error.opacity(0.2))
                                                        .border_color(theme.colors.error.opacity(0.5))
                                                })
                                                .on_click(cx.listener(|this, _, _window, cx| {
                                                    this.deny_all_permissions(cx);
                                                }))
                                                .child("√ó√ó")
                                                .child("Deny All")
                                        )
                                )
                            })
                    )
            )
    }

    // ==================== Render: MCP Servers Panel ====================

    /// Render MCP servers panel
    pub fn render_mcp_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let servers = self.session_info.as_ref()
            .map(|info| info.mcp_servers.clone())
            .unwrap_or_default();

        // Count connected vs total
        let connected_count = servers.iter()
            .filter(|s| s.status == crate::claude::message::McpServerStatus::Connected)
            .count();
        let total_tools: usize = servers.iter().map(|s| s.tool_count).sum();
        let total_resources: usize = servers.iter().map(|s| s.resource_count).sum();

        div()
            .id("mcp-panel-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.5))
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_mcp_panel(cx);
            }))
            .child(
                div()
                    .id("mcp-panel")
                    .w(px(500.0))
                    .max_h(px(500.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.border)
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    .on_click(|_, _, _| {})
                    // Header
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(div().text_base().child("üîå"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .font_weight(FontWeight::SEMIBOLD)
                                            .text_color(theme.colors.text)
                                            .child("MCP Servers")
                                    )
                                    .child(
                                        div()
                                            .px_2()
                                            .py_px()
                                            .rounded_full()
                                            .bg(if connected_count == servers.len() && !servers.is_empty() {
                                                theme.colors.success.opacity(0.2)
                                            } else if connected_count > 0 {
                                                theme.colors.warning.opacity(0.2)
                                            } else {
                                                theme.colors.text_muted.opacity(0.2)
                                            })
                                            .text_xs()
                                            .text_color(if connected_count == servers.len() && !servers.is_empty() {
                                                theme.colors.success
                                            } else if connected_count > 0 {
                                                theme.colors.warning
                                            } else {
                                                theme.colors.text_muted
                                            })
                                            .child(format!("{}/{} connected", connected_count, servers.len()))
                                    )
                            )
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    // Stats badges
                                    .when(total_tools > 0, |d| {
                                        d.child(
                                            div()
                                                .px_2()
                                                .py_px()
                                                .rounded_full()
                                                .bg(theme.colors.info.opacity(0.1))
                                                .text_xs()
                                                .text_color(theme.colors.info)
                                                .child(format!("üîß {}", total_tools))
                                        )
                                    })
                                    .when(total_resources > 0, |d| {
                                        d.child(
                                            div()
                                                .px_2()
                                                .py_px()
                                                .rounded_full()
                                                .bg(theme.colors.accent.opacity(0.1))
                                                .text_xs()
                                                .text_color(theme.colors.accent)
                                                .child(format!("üìÑ {}", total_resources))
                                        )
                                    })
                                    // Close button
                                    .child(
                                        div()
                                            .id("close-mcp-panel")
                                            .px_2()
                                            .py_1()
                                            .rounded_md()
                                            .cursor_pointer()
                                            .text_sm()
                                            .text_color(theme.colors.text_muted)
                                            .hover(|s| s.bg(theme.colors.surface_hover))
                                            .on_click(cx.listener(|this, _, _window, cx| {
                                                this.toggle_mcp_panel(cx);
                                            }))
                                            .child("√ó")
                                    )
                            )
                    )
                    // Server list
                    .child(
                        div()
                            .id("mcp-server-list")
                            .flex_1()
                            .overflow_y_scroll()
                            .when(servers.is_empty(), |d| {
                                d.child(
                                    div()
                                        .px_4()
                                        .py_8()
                                        .flex()
                                        .flex_col()
                                        .items_center()
                                        .gap_3()
                                        .child(
                                            div()
                                                .size(px(48.0))
                                                .rounded_full()
                                                .bg(theme.colors.text_muted.opacity(0.1))
                                                .flex()
                                                .items_center()
                                                .justify_center()
                                                .child(div().text_xl().child("üîå"))
                                        )
                                        .child(
                                            div()
                                                .text_sm()
                                                .font_weight(FontWeight::MEDIUM)
                                                .text_color(theme.colors.text)
                                                .child("No MCP servers connected")
                                        )
                                        .child(
                                            div()
                                                .text_xs()
                                                .text_color(theme.colors.text_muted)
                                                .text_center()
                                                .child("MCP (Model Context Protocol) servers extend Claude's capabilities with custom tools and resources.")
                                        )
                                        .child(
                                            div()
                                                .mt_2()
                                                .px_3()
                                                .py_2()
                                                .rounded_md()
                                                .bg(theme.colors.accent.opacity(0.1))
                                                .text_xs()
                                                .text_color(theme.colors.accent)
                                                .child("Configure in ~/.claude/settings.json")
                                        )
                                )
                            })
                            .children(servers.iter().enumerate().map(|(idx, server)| {
                                let server_name = server.name.clone();
                                let server_name_for_expand = server.name.clone();
                                let is_expanded = self.is_mcp_server_expanded(&server.name);
                                let tools = self.get_mcp_server_tools(&server.name);

                                let (status_color, status_icon, status_text) = match server.status {
                                    crate::claude::message::McpServerStatus::Connected =>
                                        (theme.colors.success, "‚óè", "Connected"),
                                    crate::claude::message::McpServerStatus::Connecting =>
                                        (theme.colors.warning, "‚óê", "Connecting..."),
                                    crate::claude::message::McpServerStatus::Disconnected =>
                                        (theme.colors.text_muted, "‚óã", "Disconnected"),
                                    crate::claude::message::McpServerStatus::Error =>
                                        (theme.colors.error, "‚úï", "Error"),
                                };

                                div()
                                    .flex()
                                    .flex_col()
                                    // Server header row (clickable to expand)
                                    .child(
                                        div()
                                            .id(ElementId::Name(format!("mcp-server-{}", idx).into()))
                                            .px_4()
                                            .py_3()
                                            .border_b_1()
                                            .border_color(theme.colors.border.opacity(0.5))
                                            .cursor_pointer()
                                            .hover(|s| s.bg(theme.colors.surface_hover))
                                            .on_click(cx.listener(move |this, _, _window, cx| {
                                                this.toggle_mcp_server_expanded(&server_name_for_expand, cx);
                                            }))
                                            .flex()
                                            .items_center()
                                            .gap_3()
                                            // Expand indicator
                                            .child(
                                                div()
                                                    .text_xs()
                                                    .text_color(theme.colors.text_muted)
                                                    .child(if is_expanded { "‚ñº" } else { "‚ñ∂" })
                                            )
                                            // Status indicator with color
                                            .child(
                                                div()
                                                    .text_xs()
                                                    .text_color(status_color)
                                                    .child(status_icon)
                                            )
                                            // Server info
                                            .child(
                                                div()
                                                    .flex_1()
                                                    .flex()
                                                    .flex_col()
                                                    .gap(px(2.0))
                                                    .child(
                                                        div()
                                                            .flex()
                                                            .items_center()
                                                            .gap_2()
                                                            .child(
                                                                div()
                                                                    .text_sm()
                                                                    .font_weight(FontWeight::MEDIUM)
                                                                    .text_color(theme.colors.text)
                                                                    .child(server.name.clone())
                                                            )
                                                            .child(
                                                                div()
                                                                    .px_2()
                                                                    .py_px()
                                                                    .rounded_sm()
                                                                    .bg(status_color.opacity(0.1))
                                                                    .text_xs()
                                                                    .text_color(status_color)
                                                                    .child(status_text)
                                                            )
                                                    )
                                                    .child(
                                                        div()
                                                            .flex()
                                                            .items_center()
                                                            .gap_3()
                                                            .text_xs()
                                                            .text_color(theme.colors.text_muted)
                                                            .child(format!("üîß {} tools", server.tool_count))
                                                            .child(format!("üìÑ {} resources", server.resource_count))
                                                    )
                                            )
                                            // Quick use button
                                            .child(
                                                div()
                                                    .id(ElementId::Name(format!("mcp-use-{}", idx).into()))
                                                    .px_2()
                                                    .py_1()
                                                    .rounded_md()
                                                    .text_xs()
                                                    .text_color(theme.colors.accent)
                                                    .bg(theme.colors.accent.opacity(0.1))
                                                    .hover(|s| s.bg(theme.colors.accent.opacity(0.2)))
                                                    .cursor_pointer()
                                                    .on_click(cx.listener({
                                                        let name = server_name.clone();
                                                        move |this, _, _window, cx| {
                                                            let prompt = format!("Use the {} MCP server to ", name);
                                                            this.input.update(cx, |input, cx| {
                                                                input.clear(cx);
                                                                input.insert_text(&prompt, cx);
                                                            });
                                                            this.show_mcp_panel = false;
                                                            cx.notify();
                                                        }
                                                    }))
                                                    .child("Use...")
                                            )
                                    )
                                    // Expanded tools list
                                    .when(is_expanded && !tools.is_empty(), |d| {
                                        d.child(
                                            div()
                                                .px_4()
                                                .py_2()
                                                .pl(px(48.0))
                                                .bg(theme.colors.background)
                                                .border_b_1()
                                                .border_color(theme.colors.border.opacity(0.3))
                                                .flex()
                                                .flex_col()
                                                .gap_1()
                                                .child(
                                                    div()
                                                        .text_xs()
                                                        .text_color(theme.colors.text_muted)
                                                        .mb_1()
                                                        .child("Available tools:")
                                                )
                                                .children(tools.iter().take(10).enumerate().map(|(tidx, tool)| {
                                                    let tool_name = tool.clone();
                                                    div()
                                                        .id(ElementId::Name(format!("mcp-tool-{}-{}", idx, tidx).into()))
                                                        .px_2()
                                                        .py_1()
                                                        .rounded_sm()
                                                        .text_xs()
                                                        .text_color(theme.colors.info)
                                                        .hover(|s| s.bg(theme.colors.info.opacity(0.1)))
                                                        .cursor_pointer()
                                                        .on_click(cx.listener(move |this, _, _window, cx| {
                                                            this.use_mcp_tool(&tool_name, cx);
                                                        }))
                                                        .child(format!("üîß {}", tool))
                                                }))
                                                .when(tools.len() > 10, |d| {
                                                    d.child(
                                                        div()
                                                            .text_xs()
                                                            .text_color(theme.colors.text_muted)
                                                            .mt_1()
                                                            .child(format!("...and {} more", tools.len() - 10))
                                                    )
                                                })
                                        )
                                    })
                                    // Show placeholder when expanded but no matching tools found
                                    .when(is_expanded && tools.is_empty(), |d| {
                                        d.child(
                                            div()
                                                .px_4()
                                                .py_2()
                                                .pl(px(48.0))
                                                .bg(theme.colors.background)
                                                .border_b_1()
                                                .border_color(theme.colors.border.opacity(0.3))
                                                .text_xs()
                                                .text_color(theme.colors.text_muted)
                                                .child(format!("{} tools available (click 'Use...' to interact)", server.tool_count))
                                        )
                                    })
                            }))
                    )
                    // Footer with help text
                    .child(
                        div()
                            .px_4()
                            .py_2()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child("Click a server to see tools ‚Ä¢ Click tool to use")
                            )
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_1()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child("‚éã")
                                    .child("Close")
                            )
                    )
            )
    }

    // ==================== Render: Commands Panel ====================

    /// Render commands panel (slash commands + skills)
    pub fn render_commands_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let (slash_commands, skills) = self.filtered_commands();
        let filter = self.commands_filter.clone();
        let category = self.commands_category;

        // Group skills by category (infer from name)
        let skill_categories: Vec<(&str, Vec<&String>)> = vec![
            ("Git", skills.iter().filter(|s| {
                let sl = s.to_lowercase();
                sl.contains("git") || sl.contains("commit") || sl.contains("pr") || sl.contains("merge")
            }).collect()),
            ("Code", skills.iter().filter(|s| {
                let sl = s.to_lowercase();
                sl.contains("code") || sl.contains("refactor") || sl.contains("review") || sl.contains("fix")
            }).collect()),
            ("Docs", skills.iter().filter(|s| {
                let sl = s.to_lowercase();
                sl.contains("doc") || sl.contains("explain") || sl.contains("comment")
            }).collect()),
            ("Other", skills.iter().filter(|s| {
                let sl = s.to_lowercase();
                !sl.contains("git") && !sl.contains("commit") && !sl.contains("pr") && !sl.contains("merge") &&
                !sl.contains("code") && !sl.contains("refactor") && !sl.contains("review") && !sl.contains("fix") &&
                !sl.contains("doc") && !sl.contains("explain") && !sl.contains("comment")
            }).collect()),
        ];

        div()
            .id("commands-panel-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.5))
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_commands_panel(cx);
            }))
            .child(
                div()
                    .id("commands-panel")
                    .w(px(550.0))
                    .max_h(px(500.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.border)
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    .on_click(|_, _, _| {})
                    // Header with search
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .flex_col()
                            .gap_2()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .justify_between()
                                    .child(
                                        div()
                                            .flex()
                                            .items_center()
                                            .gap_2()
                                            .child(div().text_base().child("‚ö°"))
                                            .child(
                                                div()
                                                    .text_sm()
                                                    .font_weight(FontWeight::SEMIBOLD)
                                                    .text_color(theme.colors.text)
                                                    .child("Commands & Skills")
                                            )
                                            .child(
                                                div()
                                                    .px_2()
                                                    .py_px()
                                                    .rounded_full()
                                                    .bg(theme.colors.accent.opacity(0.2))
                                                    .text_xs()
                                                    .text_color(theme.colors.accent)
                                                    .child(format!("{} total", slash_commands.len() + skills.len()))
                                            )
                                    )
                                    .child(
                                        div()
                                            .id("close-commands-panel")
                                            .px_2()
                                            .py_1()
                                            .rounded_md()
                                            .cursor_pointer()
                                            .text_sm()
                                            .text_color(theme.colors.text_muted)
                                            .hover(|s| s.bg(theme.colors.surface_hover))
                                            .on_click(cx.listener(|this, _, _window, cx| {
                                                this.toggle_commands_panel(cx);
                                            }))
                                            .child("√ó")
                                    )
                            )
                            // Category tabs
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_1()
                                    .children([CommandCategory::All, CommandCategory::SlashCommands, CommandCategory::Skills].into_iter().map(|cat| {
                                        let is_active = category == cat;
                                        div()
                                            .id(ElementId::Name(format!("cmd-cat-{:?}", cat).into()))
                                            .px_3()
                                            .py_1()
                                            .rounded_md()
                                            .text_xs()
                                            .cursor_pointer()
                                            .bg(if is_active { theme.colors.accent.opacity(0.2) } else { gpui::transparent_black() })
                                            .text_color(if is_active { theme.colors.accent } else { theme.colors.text_muted })
                                            .hover(|s| s.bg(theme.colors.surface_hover))
                                            .on_click(cx.listener(move |this, _, _window, cx| {
                                                this.set_commands_category(cat, cx);
                                            }))
                                            .child(format!("{} {}", cat.icon(), cat.label()))
                                    }))
                            )
                            // Search input hint
                            .child(
                                div()
                                    .px_3()
                                    .py_2()
                                    .bg(theme.colors.background)
                                    .rounded_md()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child(if filter.is_empty() {
                                        "Type / in chat to search commands...".to_string()
                                    } else {
                                        format!("Filtering: {}", filter)
                                    })
                            )
                    )
                    // Content
                    .child(
                        div()
                            .id("commands-list")
                            .flex_1()
                            .overflow_y_scroll()
                            .p_2()
                            // Slash Commands Section
                            .when(category == CommandCategory::All || category == CommandCategory::SlashCommands, |d| {
                                d.when(!slash_commands.is_empty(), |d| {
                                    d.child(
                                        div()
                                            .mb_3()
                                            .child(
                                                div()
                                                    .px_2()
                                                    .py_1()
                                                    .text_xs()
                                                    .font_weight(FontWeight::SEMIBOLD)
                                                    .text_color(theme.colors.text_muted)
                                                    .child(format!("SLASH COMMANDS ({})", slash_commands.len()))
                                            )
                                            .child(
                                                div()
                                                    .flex()
                                                    .flex_wrap()
                                                    .gap_1()
                                                    .px_2()
                                                    .children(slash_commands.iter().enumerate().map(|(idx, cmd)| {
                                                        let cmd_clone = cmd.clone();
                                                        div()
                                                            .id(ElementId::Name(format!("cmd-slash-{}", idx).into()))
                                                            .px_3()
                                                            .py_1()
                                                            .rounded_md()
                                                            .bg(theme.colors.background)
                                                            .border_1()
                                                            .border_color(theme.colors.border)
                                                            .text_xs()
                                                            .font_family("JetBrains Mono")
                                                            .text_color(theme.colors.info)
                                                            .cursor_pointer()
                                                            .hover(|s| s.bg(theme.colors.info.opacity(0.1)).border_color(theme.colors.info))
                                                            .on_click(cx.listener(move |this, _, _window, cx| {
                                                                this.use_slash_command(&cmd_clone, cx);
                                                            }))
                                                            .child(format!("/{}", cmd))
                                                    }))
                                            )
                                    )
                                })
                            })
                            // Skills Section
                            .when(category == CommandCategory::All || category == CommandCategory::Skills, |d| {
                                d.when(!skills.is_empty(), |d| {
                                    d.child(
                                        div()
                                            .mb_3()
                                            .child(
                                                div()
                                                    .px_2()
                                                    .py_1()
                                                    .text_xs()
                                                    .font_weight(FontWeight::SEMIBOLD)
                                                    .text_color(theme.colors.text_muted)
                                                    .child(format!("SKILLS ({})", skills.len()))
                                            )
                                            .children(skill_categories.iter().filter(|(_, items)| !items.is_empty()).map(|(cat_name, items)| {
                                                div()
                                                    .mb_2()
                                                    .child(
                                                        div()
                                                            .px_2()
                                                            .text_xs()
                                                            .text_color(theme.colors.text_muted)
                                                            .child(format!("{} ({})", cat_name, items.len()))
                                                    )
                                                    .child(
                                                        div()
                                                            .flex()
                                                            .flex_wrap()
                                                            .gap_1()
                                                            .px_2()
                                                            .children(items.iter().enumerate().map(|(idx, skill)| {
                                                                let skill_clone = (*skill).clone();
                                                                let skill_icon = if skill.to_lowercase().contains("commit") {
                                                                    "üìù"
                                                                } else if skill.to_lowercase().contains("review") {
                                                                    "üëÄ"
                                                                } else if skill.to_lowercase().contains("test") {
                                                                    "üß™"
                                                                } else if skill.to_lowercase().contains("debug") {
                                                                    "üêõ"
                                                                } else if skill.to_lowercase().contains("doc") {
                                                                    "üìö"
                                                                } else if skill.to_lowercase().contains("refactor") {
                                                                    "‚ôªÔ∏è"
                                                                } else {
                                                                    "‚ö°"
                                                                };
                                                                div()
                                                                    .id(ElementId::Name(format!("cmd-skill-{}-{}", cat_name, idx).into()))
                                                                    .px_3()
                                                                    .py_1()
                                                                    .rounded_md()
                                                                    .bg(theme.colors.background)
                                                                    .border_1()
                                                                    .border_color(theme.colors.border)
                                                                    .text_xs()
                                                                    .text_color(theme.colors.accent)
                                                                    .cursor_pointer()
                                                                    .hover(|s| s.bg(theme.colors.accent.opacity(0.1)).border_color(theme.colors.accent))
                                                                    .on_click(cx.listener(move |this, _, _window, cx| {
                                                                        this.use_skill(&skill_clone, cx);
                                                                    }))
                                                                    .child(format!("{} {}", skill_icon, skill))
                                                            }))
                                                    )
                                            }))
                                    )
                                })
                            })
                            // Empty state
                            .when(slash_commands.is_empty() && skills.is_empty(), |d| {
                                d.child(
                                    div()
                                        .px_4()
                                        .py_8()
                                        .flex()
                                        .flex_col()
                                        .items_center()
                                        .gap_3()
                                        .child(
                                            div()
                                                .size(px(48.0))
                                                .rounded_full()
                                                .bg(theme.colors.text_muted.opacity(0.1))
                                                .flex()
                                                .items_center()
                                                .justify_center()
                                                .child(div().text_xl().child("‚ö°"))
                                        )
                                        .child(
                                            div()
                                                .text_sm()
                                                .font_weight(FontWeight::MEDIUM)
                                                .text_color(theme.colors.text)
                                                .child("No commands available")
                                        )
                                        .child(
                                            div()
                                                .text_xs()
                                                .text_color(theme.colors.text_muted)
                                                .text_center()
                                                .child("Start a session to load available commands and skills")
                                        )
                                )
                            })
                    )
                    // Footer with shortcuts
                    .child(
                        div()
                            .px_4()
                            .py_2()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child("Click to use ‚Ä¢ Type / to filter")
                            )
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child("‚åò/")
                                    .child("Toggle")
                            )
                    )
            )
    }

    // ==================== Render: Prompt Templates Panel ====================

    /// Render prompt templates panel
    pub fn render_templates_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let templates_by_cat = self.templates_by_category();
        let filter = self.templates_filter.clone();
        let total_count = self.prompt_templates.len();
        let custom_count = self.prompt_templates.iter().filter(|t| !t.is_builtin).count();

        // Category order
        let categories = ["coding", "review", "explain", "git", "architecture", "custom"];

        div()
            .id("templates-panel-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.5))
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_templates_panel(cx);
            }))
            .child(
                div()
                    .id("templates-panel")
                    .w(px(600.0))
                    .max_h(px(500.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.border)
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    .on_click(|_, _, _| {})
                    // Header
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(div().text_base().child("üìù"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .font_weight(FontWeight::SEMIBOLD)
                                            .text_color(theme.colors.text)
                                            .child("Prompt Templates")
                                    )
                                    .child(
                                        div()
                                            .px_2()
                                            .py_px()
                                            .rounded_full()
                                            .bg(theme.colors.accent.opacity(0.2))
                                            .text_xs()
                                            .text_color(theme.colors.accent)
                                            .child(format!("{} templates", total_count))
                                    )
                                    .when(custom_count > 0, |d| {
                                        d.child(
                                            div()
                                                .px_2()
                                                .py_px()
                                                .rounded_full()
                                                .bg(theme.colors.success.opacity(0.2))
                                                .text_xs()
                                                .text_color(theme.colors.success)
                                                .child(format!("{} custom", custom_count))
                                        )
                                    })
                            )
                            .child(
                                div()
                                    .id("close-templates-panel")
                                    .px_2()
                                    .py_1()
                                    .rounded_md()
                                    .cursor_pointer()
                                    .text_sm()
                                    .text_color(theme.colors.text_muted)
                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        this.toggle_templates_panel(cx);
                                    }))
                                    .child("√ó")
                            )
                    )
                    // Search bar
                    .child(
                        div()
                            .px_4()
                            .py_2()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .child(
                                div()
                                    .w_full()
                                    .h(px(32.0))
                                    .px_3()
                                    .rounded_md()
                                    .bg(theme.colors.background)
                                    .border_1()
                                    .border_color(theme.colors.border)
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(
                                        div()
                                            .text_sm()
                                            .text_color(theme.colors.text_muted)
                                            .child("üîç")
                                    )
                                    .child(
                                        div()
                                            .flex_1()
                                            .text_sm()
                                            .text_color(if filter.is_empty() { theme.colors.text_muted } else { theme.colors.text })
                                            .child(if filter.is_empty() {
                                                "Search templates...".to_string()
                                            } else {
                                                filter
                                            })
                                    )
                            )
                    )
                    // Templates list
                    .child(
                        div()
                            .id("templates-list")
                            .flex_1()
                            .overflow_y_scroll()
                            .p_4()
                            .children(categories.iter().filter_map(|&cat| {
                                templates_by_cat.get(cat).map(|templates| {
                                    let cat_icon = match cat {
                                        "coding" => "üíª",
                                        "review" => "üîç",
                                        "explain" => "üí°",
                                        "git" => "üì¶",
                                        "architecture" => "üèóÔ∏è",
                                        "custom" => "üìå",
                                        _ => "üìÑ",
                                    };
                                    let cat_label = match cat {
                                        "coding" => "Coding",
                                        "review" => "Code Review",
                                        "explain" => "Explanations",
                                        "git" => "Git & PRs",
                                        "architecture" => "Architecture",
                                        "custom" => "Custom Templates",
                                        _ => cat,
                                    };

                                    div()
                                        .mb_4()
                                        // Category header
                                        .child(
                                            div()
                                                .flex()
                                                .items_center()
                                                .gap_2()
                                                .mb_2()
                                                .child(
                                                    div()
                                                        .text_xs()
                                                        .child(cat_icon.to_string())
                                                )
                                                .child(
                                                    div()
                                                        .text_xs()
                                                        .font_weight(FontWeight::SEMIBOLD)
                                                        .text_color(theme.colors.text_muted)
                                                        .child(cat_label.to_string())
                                                )
                                                .child(
                                                    div()
                                                        .h(px(1.0))
                                                        .flex_1()
                                                        .bg(theme.colors.border.opacity(0.5))
                                                )
                                        )
                                        // Templates in category
                                        .child(
                                            div()
                                                .flex()
                                                .flex_col()
                                                .gap_2()
                                                .children(templates.iter().map(|template| {
                                                    let template_id = template.id.clone();
                                                    let template_id_delete = template.id.clone();
                                                    let is_builtin = template.is_builtin;

                                                    div()
                                                        .id(ElementId::Name(format!("template-{}", template.id).into()))
                                                        .w_full()
                                                        .px_3()
                                                        .py_2()
                                                        .rounded_md()
                                                        .border_1()
                                                        .border_color(theme.colors.border.opacity(0.5))
                                                        .bg(theme.colors.background)
                                                        .cursor_pointer()
                                                        .hover(|s| s.bg(theme.colors.surface_hover).border_color(theme.colors.accent.opacity(0.5)))
                                                        .on_click(cx.listener(move |this, _, _window, cx| {
                                                            this.use_template(&template_id, cx);
                                                        }))
                                                        .flex()
                                                        .items_start()
                                                        .gap_3()
                                                        // Icon
                                                        .child(
                                                            div()
                                                                .size(px(24.0))
                                                                .rounded_md()
                                                                .bg(theme.colors.accent.opacity(0.1))
                                                                .flex()
                                                                .items_center()
                                                                .justify_center()
                                                                .flex_shrink_0()
                                                                .text_sm()
                                                                .child(template.icon.to_string())
                                                        )
                                                        // Content
                                                        .child(
                                                            div()
                                                                .flex_1()
                                                                .overflow_hidden()
                                                                .child(
                                                                    div()
                                                                        .text_sm()
                                                                        .font_weight(FontWeight::MEDIUM)
                                                                        .text_color(theme.colors.text)
                                                                        .child(template.name.clone())
                                                                )
                                                                .child(
                                                                    div()
                                                                        .text_xs()
                                                                        .text_color(theme.colors.text_muted)
                                                                        .line_clamp(2)
                                                                        .child(template.content.chars().take(100).collect::<String>())
                                                                )
                                                        )
                                                        // Actions
                                                        .child(
                                                            div()
                                                                .flex()
                                                                .items_center()
                                                                .gap_1()
                                                                .flex_shrink_0()
                                                                .when(template.usage_count > 0, |d| {
                                                                    d.child(
                                                                        div()
                                                                            .text_xs()
                                                                            .text_color(theme.colors.text_muted)
                                                                            .child(format!("{}x", template.usage_count))
                                                                    )
                                                                })
                                                                .when(!is_builtin, |d| {
                                                                    d.child(
                                                                        div()
                                                                            .id(ElementId::Name(format!("delete-template-{}", template_id_delete).into()))
                                                                            .size(px(20.0))
                                                                            .rounded_md()
                                                                            .flex()
                                                                            .items_center()
                                                                            .justify_center()
                                                                            .text_xs()
                                                                            .text_color(theme.colors.text_muted)
                                                                            .hover(|s| s.bg(theme.colors.error.opacity(0.1)).text_color(theme.colors.error))
                                                                            .cursor_pointer()
                                                                            .on_click(cx.listener(move |this, _, _window, cx| {
                                                                                this.delete_template(&template_id_delete, cx);
                                                                            }))
                                                                            .child("√ó")
                                                                    )
                                                                })
                                                        )
                                                }))
                                        )
                                })
                            }))
                            // Empty state
                            .when(templates_by_cat.is_empty(), |d| {
                                d.child(
                                    div()
                                        .py_8()
                                        .flex()
                                        .flex_col()
                                        .items_center()
                                        .gap_3()
                                        .child(
                                            div()
                                                .size(px(48.0))
                                                .rounded_full()
                                                .bg(theme.colors.text_muted.opacity(0.1))
                                                .flex()
                                                .items_center()
                                                .justify_center()
                                                .child(div().text_xl().child("üìù"))
                                        )
                                        .child(
                                            div()
                                                .text_sm()
                                                .font_weight(FontWeight::MEDIUM)
                                                .text_color(theme.colors.text)
                                                .child("No templates found")
                                        )
                                        .child(
                                            div()
                                                .text_xs()
                                                .text_color(theme.colors.text_muted)
                                                .child("Try a different search term")
                                        )
                                )
                            })
                    )
                    // Footer
                    .child(
                        div()
                            .px_4()
                            .py_2()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child("Click to insert ‚Ä¢ Type to filter")
                            )
                            .child(
                                div()
                                    .id("save-as-template-btn")
                                    .px_3()
                                    .py_1()
                                    .rounded_md()
                                    .bg(theme.colors.accent.opacity(0.1))
                                    .text_xs()
                                    .text_color(theme.colors.accent)
                                    .cursor_pointer()
                                    .hover(|s| s.bg(theme.colors.accent.opacity(0.2)))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        // For now, just show a notification
                                        // In a full implementation, this would open a name dialog
                                        this.show_notification("Use ‚åòS to save current input as template", NotificationType::Info, cx);
                                    }))
                                    .child("+ Save Current as Template")
                            )
                    )
            )
    }

    // ==================== Render: Context Panel ====================

    /// Render context panel showing files, tools, and session context
    pub fn render_context_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let session_info = self.session_info.as_ref();
        let file_count = self.context_files.len();
        let tool_count = session_info.map(|i| i.tools.len()).unwrap_or(0);
        let usage_pct = self.context_usage_percentage();
        let usage_color = if usage_pct < 0.5 {
            theme.colors.success
        } else if usage_pct < 0.8 {
            theme.colors.warning
        } else {
            theme.colors.error
        };

        div()
            .id("context-panel-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.5))
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_context_panel(cx);
            }))
            .child(
                div()
                    .id("context-panel")
                    .w(px(550.0))
                    .max_h(px(500.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.border)
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    .on_click(|_, _, _| {})
                    // Header
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(div().text_base().child("üìö"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .font_weight(FontWeight::SEMIBOLD)
                                            .text_color(theme.colors.text)
                                            .child("Session Context")
                                    )
                            )
                            .child(
                                div()
                                    .id("close-context-panel")
                                    .px_2()
                                    .py_1()
                                    .rounded_md()
                                    .cursor_pointer()
                                    .text_sm()
                                    .text_color(theme.colors.text_muted)
                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        this.toggle_context_panel(cx);
                                    }))
                                    .child("√ó")
                            )
                    )
                    // Context usage bar
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .bg(theme.colors.background.opacity(0.5))
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .justify_between()
                                    .mb_2()
                                    .child(
                                        div()
                                            .text_xs()
                                            .text_color(theme.colors.text_muted)
                                            .child("Context Window Usage")
                                    )
                                    .child(
                                        div()
                                            .text_xs()
                                            .font_weight(FontWeight::MEDIUM)
                                            .text_color(usage_color)
                                            .child(format!("{}%", (usage_pct * 100.0) as u32))
                                    )
                            )
                            .child(
                                div()
                                    .w_full()
                                    .h(px(6.0))
                                    .rounded_full()
                                    .bg(theme.colors.border)
                                    .overflow_hidden()
                                    .child(
                                        div()
                                            .h_full()
                                            .w(pct((usage_pct * 100.0) as f32))
                                            .bg(usage_color)
                                            .rounded_full()
                                    )
                            )
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .justify_between()
                                    .mt_2()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child(self.format_context_usage())
                                    .child(
                                        div()
                                            .flex()
                                            .items_center()
                                            .gap_3()
                                            .child(format!("{} files", file_count))
                                            .child(format!("{} tools", tool_count))
                                    )
                            )
                    )
                    // Content scrollable area
                    .child(
                        div()
                            .id("context-panel-content")
                            .flex_1()
                            .overflow_y_scroll()
                            .p_4()
                            // Files section
                            .child(
                                div()
                                    .mb_4()
                                    .child(
                                        div()
                                            .flex()
                                            .items_center()
                                            .justify_between()
                                            .mb_2()
                                            .child(
                                                div()
                                                    .flex()
                                                    .items_center()
                                                    .gap_2()
                                                    .child(div().text_sm().child("üìÅ"))
                                                    .child(
                                                        div()
                                                            .text_xs()
                                                            .font_weight(FontWeight::SEMIBOLD)
                                                            .text_color(theme.colors.text_muted)
                                                            .child("Context Files")
                                                    )
                                            )
                                            .when(!self.context_files.is_empty(), |d| {
                                                d.child(
                                                    div()
                                                        .id("clear-context-files")
                                                        .px_2()
                                                        .py_0p5()
                                                        .rounded_md()
                                                        .text_xs()
                                                        .text_color(theme.colors.text_muted)
                                                        .cursor_pointer()
                                                        .hover(|s| s.bg(theme.colors.surface_hover).text_color(theme.colors.error))
                                                        .on_click(cx.listener(|this, _, _window, cx| {
                                                            this.clear_context_files(cx);
                                                        }))
                                                        .child("Clear all")
                                                )
                                            })
                                    )
                                    .when(self.context_files.is_empty(), |d| {
                                        d.child(
                                            div()
                                                .px_3()
                                                .py_4()
                                                .rounded_md()
                                                .bg(theme.colors.background)
                                                .border_1()
                                                .border_color(theme.colors.border.opacity(0.5))
                                                .text_center()
                                                .child(
                                                    div()
                                                        .text_xs()
                                                        .text_color(theme.colors.text_muted)
                                                        .child("No files in context")
                                                )
                                                .child(
                                                    div()
                                                        .text_xs()
                                                        .text_color(theme.colors.text_muted)
                                                        .mt_1()
                                                        .child("Use @file:path to add files")
                                                )
                                        )
                                    })
                                    .when(!self.context_files.is_empty(), |d| {
                                        d.child(
                                            div()
                                                .flex()
                                                .flex_col()
                                                .gap_1()
                                                .children(self.context_files.iter().map(|file| {
                                                    let file_path = file.path.clone();
                                                    div()
                                                        .id(ElementId::Name(format!("ctx-file-{}", file.path).into()))
                                                        .w_full()
                                                        .px_3()
                                                        .py_2()
                                                        .rounded_md()
                                                        .bg(theme.colors.background)
                                                        .border_1()
                                                        .border_color(theme.colors.border.opacity(0.5))
                                                        .flex()
                                                        .items_center()
                                                        .gap_2()
                                                        .hover(|s| s.border_color(theme.colors.accent.opacity(0.5)))
                                                        .child(
                                                            div()
                                                                .text_sm()
                                                                .child(file.file_type.icon())
                                                        )
                                                        .child(
                                                            div()
                                                                .flex_1()
                                                                .overflow_hidden()
                                                                .child(
                                                                    div()
                                                                        .text_xs()
                                                                        .font_weight(FontWeight::MEDIUM)
                                                                        .text_color(theme.colors.text)
                                                                        .child(file.name.clone())
                                                                )
                                                                .child(
                                                                    div()
                                                                        .text_xs()
                                                                        .text_color(theme.colors.text_muted)
                                                                        .overflow_hidden()
                                                                        .child(file.path.clone())
                                                                )
                                                        )
                                                        .child(
                                                            div()
                                                                .id(ElementId::Name(format!("remove-ctx-{}", file.path).into()))
                                                                .size(px(20.0))
                                                                .rounded_md()
                                                                .flex()
                                                                .items_center()
                                                                .justify_center()
                                                                .text_xs()
                                                                .text_color(theme.colors.text_muted)
                                                                .cursor_pointer()
                                                                .hover(|s| s.bg(theme.colors.error.opacity(0.1)).text_color(theme.colors.error))
                                                                .on_click(cx.listener(move |this, _, _window, cx| {
                                                                    this.remove_context_file(&file_path, cx);
                                                                }))
                                                                .child("√ó")
                                                        )
                                                }))
                                        )
                                    })
                            )
                            // Tools section
                            .when_some(session_info, |d, info| {
                                d.child(
                                    div()
                                        .mb_4()
                                        .child(
                                            div()
                                                .flex()
                                                .items_center()
                                                .gap_2()
                                                .mb_2()
                                                .child(div().text_sm().child("üîß"))
                                                .child(
                                                    div()
                                                        .text_xs()
                                                        .font_weight(FontWeight::SEMIBOLD)
                                                        .text_color(theme.colors.text_muted)
                                                        .child(format!("Available Tools ({})", info.tools.len()))
                                                )
                                        )
                                        .child(
                                            div()
                                                .flex()
                                                .flex_wrap()
                                                .gap_1()
                                                .children(info.tools.iter().take(20).map(|tool| {
                                                    div()
                                                        .px_2()
                                                        .py_0p5()
                                                        .rounded_md()
                                                        .bg(theme.colors.accent.opacity(0.1))
                                                        .text_xs()
                                                        .text_color(theme.colors.accent)
                                                        .child(tool.clone())
                                                }))
                                                .when(info.tools.len() > 20, |d| {
                                                    d.child(
                                                        div()
                                                            .px_2()
                                                            .py_0p5()
                                                            .rounded_md()
                                                            .bg(theme.colors.text_muted.opacity(0.1))
                                                            .text_xs()
                                                            .text_color(theme.colors.text_muted)
                                                            .child(format!("+{} more", info.tools.len() - 20))
                                                    )
                                                })
                                        )
                                )
                            })
                            // Session info
                            .when_some(session_info, |d, info| {
                                d.child(
                                    div()
                                        .child(
                                            div()
                                                .flex()
                                                .items_center()
                                                .gap_2()
                                                .mb_2()
                                                .child(div().text_sm().child("üìã"))
                                                .child(
                                                    div()
                                                        .text_xs()
                                                        .font_weight(FontWeight::SEMIBOLD)
                                                        .text_color(theme.colors.text_muted)
                                                        .child("Session Info")
                                                )
                                        )
                                        .child(
                                            div()
                                                .px_3()
                                                .py_2()
                                                .rounded_md()
                                                .bg(theme.colors.background)
                                                .border_1()
                                                .border_color(theme.colors.border.opacity(0.5))
                                                .flex()
                                                .flex_col()
                                                .gap_2()
                                                .child(
                                                    div()
                                                        .flex()
                                                        .items_center()
                                                        .justify_between()
                                                        .child(
                                                            div()
                                                                .text_xs()
                                                                .text_color(theme.colors.text_muted)
                                                                .child("Model")
                                                        )
                                                        .child(
                                                            div()
                                                                .text_xs()
                                                                .font_weight(FontWeight::MEDIUM)
                                                                .text_color(theme.colors.text)
                                                                .child(info.model.clone())
                                                        )
                                                )
                                                .child(
                                                    div()
                                                        .flex()
                                                        .items_center()
                                                        .justify_between()
                                                        .child(
                                                            div()
                                                                .text_xs()
                                                                .text_color(theme.colors.text_muted)
                                                                .child("Working Directory")
                                                        )
                                                        .child(
                                                            div()
                                                                .text_xs()
                                                                .font_weight(FontWeight::MEDIUM)
                                                                .text_color(theme.colors.text)
                                                                .max_w(px(250.0))
                                                                .overflow_hidden()
                                                                .child(info.cwd.clone())
                                                        )
                                                )
                                                .when(!info.session_id.is_empty(), |d| {
                                                    d.child(
                                                        div()
                                                            .flex()
                                                            .items_center()
                                                            .justify_between()
                                                            .child(
                                                                div()
                                                                    .text_xs()
                                                                    .text_color(theme.colors.text_muted)
                                                                    .child("Session ID")
                                                            )
                                                            .child(
                                                                div()
                                                                    .text_xs()
                                                                    .font_family("monospace")
                                                                    .text_color(theme.colors.text)
                                                                    .child(info.session_id.chars().take(16).collect::<String>() + "...")
                                                            )
                                                    )
                                                })
                                        )
                                )
                            })
                    )
                    // Footer
                    .child(
                        div()
                            .px_4()
                            .py_2()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child("@file:path to add files")
                            )
                            .child(
                                div()
                                    .id("compact-context-btn")
                                    .px_3()
                                    .py_1()
                                    .rounded_md()
                                    .bg(theme.colors.warning.opacity(0.1))
                                    .text_xs()
                                    .text_color(theme.colors.warning)
                                    .cursor_pointer()
                                    .hover(|s| s.bg(theme.colors.warning.opacity(0.2)))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        this.send_slash_command("/compact", cx);
                                        this.toggle_context_panel(cx);
                                    }))
                                    .child("/compact to free space")
                            )
                    )
            )
    }

    // ==================== Render: Export Panel ====================

    /// Render export panel with format options
    pub fn render_export_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let stats = self.calculate_stats();
        let has_messages = !self.messages.is_empty();
        let current_format = self.export_format;

        div()
            .id("export-panel-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.5))
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_export_panel(cx);
            }))
            .child(
                div()
                    .id("export-panel")
                    .w(px(450.0))
                    .max_h(px(500.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.border)
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    .on_click(|_, _, _| {})
                    // Header
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(div().text_base().child("üíæ"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .font_weight(FontWeight::SEMIBOLD)
                                            .text_color(theme.colors.text)
                                            .child("Export Conversation")
                                    )
                            )
                            .child(
                                div()
                                    .id("close-export-panel")
                                    .px_2()
                                    .py_1()
                                    .rounded_md()
                                    .cursor_pointer()
                                    .text_sm()
                                    .text_color(theme.colors.text_muted)
                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        this.toggle_export_panel(cx);
                                    }))
                                    .child("√ó")
                            )
                    )
                    // Stats summary
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .bg(theme.colors.background.opacity(0.5))
                            .flex()
                            .items_center()
                            .gap_4()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_1()
                                    .child(div().text_sm().child("üí¨"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .text_color(theme.colors.text)
                                            .child(format!("{} messages", stats.message_count))
                                    )
                            )
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_1()
                                    .child(div().text_sm().child("üìù"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .text_color(theme.colors.text)
                                            .child(format!("{} words", stats.format_words()))
                                    )
                            )
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_1()
                                    .child(div().text_sm().child("‚è±Ô∏è"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .text_color(theme.colors.text)
                                            .child(stats.format_duration())
                                    )
                            )
                    )
                    // Format selection
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .mb_2()
                                    .child("Export Format")
                            )
                            .child(
                                div()
                                    .flex()
                                    .gap_2()
                                    .children(ExportFormat::all().iter().map(|format| {
                                        let is_selected = *format == current_format;
                                        let format_copy = *format;
                                        div()
                                            .id(ElementId::Name(format!("format-{:?}", format).into()))
                                            .flex_1()
                                            .px_3()
                                            .py_2()
                                            .rounded_lg()
                                            .cursor_pointer()
                                            .border_1()
                                            .when(is_selected, |d| {
                                                d.bg(theme.colors.accent.opacity(0.15))
                                                    .border_color(theme.colors.accent)
                                            })
                                            .when(!is_selected, |d| {
                                                d.bg(theme.colors.background)
                                                    .border_color(theme.colors.border)
                                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                            })
                                            .on_click(cx.listener(move |this, _, _window, cx| {
                                                this.set_export_format(format_copy, cx);
                                            }))
                                            .child(
                                                div()
                                                    .flex()
                                                    .flex_col()
                                                    .items_center()
                                                    .gap_1()
                                                    .child(div().text_base().child(format.icon()))
                                                    .child(
                                                        div()
                                                            .text_xs()
                                                            .font_weight(if is_selected { FontWeight::SEMIBOLD } else { FontWeight::NORMAL })
                                                            .text_color(if is_selected { theme.colors.accent } else { theme.colors.text })
                                                            .child(format.display_name())
                                                    )
                                            )
                                    }))
                            )
                    )
                    // Options
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .mb_2()
                                    .child("Include in Export")
                            )
                            .child(
                                div()
                                    .flex()
                                    .flex_col()
                                    .gap_2()
                                    // Metadata option
                                    .child({
                                        let include_meta = self.export_include_metadata;
                                        div()
                                            .id("export-option-metadata")
                                            .flex()
                                            .items_center()
                                            .gap_2()
                                            .cursor_pointer()
                                            .on_click(cx.listener(|this, _, _window, cx| {
                                                this.toggle_export_metadata(cx);
                                            }))
                                            .child(
                                                div()
                                                    .w(px(16.0))
                                                    .h(px(16.0))
                                                    .rounded_sm()
                                                    .border_1()
                                                    .border_color(if include_meta { theme.colors.accent } else { theme.colors.border })
                                                    .bg(if include_meta { theme.colors.accent } else { theme.colors.background })
                                                    .flex()
                                                    .items_center()
                                                    .justify_center()
                                                    .when(include_meta, |d| {
                                                        d.child(div().text_xs().text_color(theme.colors.surface).child("‚úì"))
                                                    })
                                            )
                                            .child(
                                                div()
                                                    .text_sm()
                                                    .text_color(theme.colors.text)
                                                    .child("Metadata & Stats")
                                            )
                                    })
                                    // Tools option
                                    .child({
                                        let include_tools = self.export_include_tools;
                                        div()
                                            .id("export-option-tools")
                                            .flex()
                                            .items_center()
                                            .gap_2()
                                            .cursor_pointer()
                                            .on_click(cx.listener(|this, _, _window, cx| {
                                                this.toggle_export_tools(cx);
                                            }))
                                            .child(
                                                div()
                                                    .w(px(16.0))
                                                    .h(px(16.0))
                                                    .rounded_sm()
                                                    .border_1()
                                                    .border_color(if include_tools { theme.colors.accent } else { theme.colors.border })
                                                    .bg(if include_tools { theme.colors.accent } else { theme.colors.background })
                                                    .flex()
                                                    .items_center()
                                                    .justify_center()
                                                    .when(include_tools, |d| {
                                                        d.child(div().text_xs().text_color(theme.colors.surface).child("‚úì"))
                                                    })
                                            )
                                            .child(
                                                div()
                                                    .text_sm()
                                                    .text_color(theme.colors.text)
                                                    .child("Tool Calls & Results")
                                            )
                                    })
                                    // Thinking option
                                    .child({
                                        let include_thinking = self.export_include_thinking;
                                        div()
                                            .id("export-option-thinking")
                                            .flex()
                                            .items_center()
                                            .gap_2()
                                            .cursor_pointer()
                                            .on_click(cx.listener(|this, _, _window, cx| {
                                                this.toggle_export_thinking(cx);
                                            }))
                                            .child(
                                                div()
                                                    .w(px(16.0))
                                                    .h(px(16.0))
                                                    .rounded_sm()
                                                    .border_1()
                                                    .border_color(if include_thinking { theme.colors.accent } else { theme.colors.border })
                                                    .bg(if include_thinking { theme.colors.accent } else { theme.colors.background })
                                                    .flex()
                                                    .items_center()
                                                    .justify_center()
                                                    .when(include_thinking, |d| {
                                                        d.child(div().text_xs().text_color(theme.colors.surface).child("‚úì"))
                                                    })
                                            )
                                            .child(
                                                div()
                                                    .text_sm()
                                                    .text_color(theme.colors.text)
                                                    .child("Thinking/Reasoning")
                                            )
                                    })
                            )
                    )
                    // Actions
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .text_xs()
                                    .text_color(theme.colors.text_muted)
                                    .child(format!("Output: conversation.{}", current_format.extension()))
                            )
                            .child(
                                div()
                                    .flex()
                                    .gap_2()
                                    // Copy to clipboard button
                                    .child(
                                        div()
                                            .id("export-copy-btn")
                                            .px_3()
                                            .py_1p5()
                                            .rounded_md()
                                            .cursor_pointer()
                                            .bg(theme.colors.surface_hover)
                                            .hover(|s| s.bg(theme.colors.border))
                                            .when(!has_messages, |d| {
                                                d.opacity(0.5).cursor_not_allowed()
                                            })
                                            .on_click(cx.listener(|this, _, _window, cx| {
                                                if this.has_messages() {
                                                    let content = this.export_with_format();
                                                    cx.write_to_clipboard(ClipboardItem::new_string(content));
                                                    this.show_notification(
                                                        format!("Copied as {}", this.export_format.display_name()),
                                                        NotificationType::Success,
                                                        cx
                                                    );
                                                    this.toggle_export_panel(cx);
                                                }
                                            }))
                                            .child(
                                                div()
                                                    .text_sm()
                                                    .text_color(theme.colors.text)
                                                    .child("Copy")
                                            )
                                    )
                                    // Export button
                                    .child(
                                        div()
                                            .id("export-save-btn")
                                            .px_3()
                                            .py_1p5()
                                            .rounded_md()
                                            .cursor_pointer()
                                            .bg(theme.colors.accent)
                                            .hover(|s| s.bg(theme.colors.accent_hover))
                                            .when(!has_messages, |d| {
                                                d.opacity(0.5).cursor_not_allowed()
                                            })
                                            .on_click(cx.listener(|this, _, _window, cx| {
                                                if this.has_messages() {
                                                    let content = this.export_with_format();
                                                    cx.write_to_clipboard(ClipboardItem::new_string(content));
                                                    this.show_notification(
                                                        format!("Exported as {} (copied to clipboard)", this.export_format.display_name()),
                                                        NotificationType::Success,
                                                        cx
                                                    );
                                                    this.toggle_export_panel(cx);
                                                }
                                            }))
                                            .child(
                                                div()
                                                    .text_sm()
                                                    .font_weight(FontWeight::MEDIUM)
                                                    .text_color(theme.colors.surface)
                                                    .child("Export")
                                            )
                                    )
                            )
                    )
            )
    }

    // ==================== Render: Notes Panel ====================

    /// Render session notes panel
    pub fn render_notes_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let has_notes = self.has_notes();

        div()
            .id("notes-panel-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.5))
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_notes_panel(cx);
            }))
            .child(
                div()
                    .id("notes-panel")
                    .w(px(500.0))
                    .max_h(px(400.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.border)
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    .on_click(|_, _, _| {})
                    // Header
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(div().text_base().child("üìù"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .font_weight(FontWeight::SEMIBOLD)
                                            .text_color(theme.colors.text)
                                            .child("Session Notes")
                                    )
                            )
                            .child(
                                div()
                                    .id("close-notes-panel")
                                    .px_2()
                                    .py_1()
                                    .rounded_md()
                                    .cursor_pointer()
                                    .text_sm()
                                    .text_color(theme.colors.text_muted)
                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        this.toggle_notes_panel(cx);
                                    }))
                                    .child("√ó")
                            )
                    )
                    // Notes content
                    .child(
                        div()
                            .id("notes-content")
                            .flex_1()
                            .p_4()
                            .overflow_y_scroll()
                            .child(
                                div()
                                    .text_sm()
                                    .text_color(if has_notes { theme.colors.text } else { theme.colors.text_muted })
                                    .child(if has_notes {
                                        self.session_notes.clone()
                                    } else {
                                        "No notes yet. Notes are saved with your session.".to_string()
                                    })
                            )
                    )
                    // Tags section
                    .when(self.has_tags(), |d| {
                        d.child(
                            div()
                                .px_4()
                                .py_2()
                                .border_t_1()
                                .border_color(theme.colors.border)
                                .child(
                                    div()
                                        .text_xs()
                                        .text_color(theme.colors.text_muted)
                                        .mb_2()
                                        .child("Tags")
                                )
                                .child(
                                    div()
                                        .flex()
                                        .flex_wrap()
                                        .gap_1()
                                        .children(self.conversation_tags.iter().map(|tag| {
                                            div()
                                                .px_2()
                                                .py_0p5()
                                                .rounded_full()
                                                .bg(theme.colors.accent.opacity(0.15))
                                                .text_xs()
                                                .text_color(theme.colors.accent)
                                                .child(format!("#{}", tag))
                                        }))
                                )
                        )
                    })
                    // Suggested tags
                    .child({
                        let suggestions = self.suggest_tags();
                        div()
                            .px_4()
                            .py_2()
                            .border_t_1()
                            .border_color(theme.colors.border)
                            .when(!suggestions.is_empty(), |d| {
                                d.child(
                                    div()
                                        .text_xs()
                                        .text_color(theme.colors.text_muted)
                                        .mb_2()
                                        .child("Suggested tags (click to add)")
                                )
                                .child(
                                    div()
                                        .flex()
                                        .flex_wrap()
                                        .gap_1()
                                        .children(suggestions.iter().map(|tag| {
                                            let tag_str = *tag;
                                            div()
                                                .id(ElementId::Name(format!("suggest-tag-{}", tag).into()))
                                                .px_2()
                                                .py_0p5()
                                                .rounded_full()
                                                .cursor_pointer()
                                                .bg(theme.colors.surface_hover)
                                                .text_xs()
                                                .text_color(theme.colors.text_muted)
                                                .hover(|s| s.bg(theme.colors.accent.opacity(0.15)).text_color(theme.colors.accent))
                                                .on_click(cx.listener(move |this, _, _window, cx| {
                                                    this.add_tag(tag_str.to_string(), cx);
                                                }))
                                                .child(format!("+{}", tag))
                                        }))
                                )
                            })
                    })
            )
    }

    // ==================== Render: Favorites Panel ====================

    /// Render favorites panel
    pub fn render_favorites_panel(&self, theme: &crate::app::theme::Theme, cx: &mut Context<Self>) -> impl IntoElement {
        let favorites = self.favorites_by_usage();
        let has_favorites = !favorites.is_empty();

        div()
            .id("favorites-panel-overlay")
            .absolute()
            .inset_0()
            .flex()
            .items_center()
            .justify_center()
            .bg(hsla(0.0, 0.0, 0.0, 0.5))
            .on_click(cx.listener(|this, _, _window, cx| {
                this.toggle_favorites_panel(cx);
            }))
            .child(
                div()
                    .id("favorites-panel")
                    .w(px(500.0))
                    .max_h(px(450.0))
                    .bg(theme.colors.surface)
                    .rounded_lg()
                    .border_1()
                    .border_color(theme.colors.border)
                    .shadow_lg()
                    .overflow_hidden()
                    .flex()
                    .flex_col()
                    .on_click(|_, _, _| {})
                    // Header
                    .child(
                        div()
                            .px_4()
                            .py_3()
                            .border_b_1()
                            .border_color(theme.colors.border)
                            .flex()
                            .items_center()
                            .justify_between()
                            .child(
                                div()
                                    .flex()
                                    .items_center()
                                    .gap_2()
                                    .child(div().text_base().child("‚≠ê"))
                                    .child(
                                        div()
                                            .text_sm()
                                            .font_weight(FontWeight::SEMIBOLD)
                                            .text_color(theme.colors.text)
                                            .child("Favorite Prompts")
                                    )
                                    .when(has_favorites, |d| {
                                        d.child(
                                            div()
                                                .px_2()
                                                .py_0p5()
                                                .rounded_full()
                                                .bg(theme.colors.accent.opacity(0.15))
                                                .text_xs()
                                                .text_color(theme.colors.accent)
                                                .child(format!("{}", favorites.len()))
                                        )
                                    })
                            )
                            .child(
                                div()
                                    .id("close-favorites-panel")
                                    .px_2()
                                    .py_1()
                                    .rounded_md()
                                    .cursor_pointer()
                                    .text_sm()
                                    .text_color(theme.colors.text_muted)
                                    .hover(|s| s.bg(theme.colors.surface_hover))
                                    .on_click(cx.listener(|this, _, _window, cx| {
                                        this.toggle_favorites_panel(cx);
                                    }))
                                    .child("√ó")
                            )
                    )
                    // Favorites list
                    .child(
                        div()
                            .id("favorites-list")
                            .flex_1()
                            .overflow_y_scroll()
                            .when(!has_favorites, |d| {
                                d.child(
                                    div()
                                        .p_8()
                                        .flex()
                                        .flex_col()
                                        .items_center()
                                        .gap_2()
                                        .child(div().text_3xl().child("‚≠ê"))
                                        .child(
                                            div()
                                                .text_sm()
                                                .text_color(theme.colors.text_muted)
                                                .child("No favorites yet")
                                        )
                                        .child(
                                            div()
                                                .text_xs()
                                                .text_color(theme.colors.text_muted)
                                                .child("Use ‚åòK ‚Üí 'Save to Favorites' to save prompts")
                                        )
                                )
                            })
                            .when(has_favorites, |d| {
                                d.children(favorites.iter().map(|fav| {
                                    let fav_id = fav.id.clone();
                                    let fav_id_delete = fav.id.clone();
                                    div()
                                        .id(ElementId::Name(format!("fav-{}", fav.id).into()))
                                        .px_4()
                                        .py_3()
                                        .border_b_1()
                                        .border_color(theme.colors.border.opacity(0.5))
                                        .cursor_pointer()
                                        .hover(|s| s.bg(theme.colors.surface_hover))
                                        .on_click(cx.listener(move |this, _, _window, cx| {
                                            this.use_favorite(&fav_id, cx);
                                        }))
                                        .child(
                                            div()
                                                .flex()
                                                .items_start()
                                                .justify_between()
                                                .gap_2()
                                                .child(
                                                    div()
                                                        .flex_1()
                                                        .child(
                                                            div()
                                                                .text_sm()
                                                                .font_weight(FontWeight::MEDIUM)
                                                                .text_color(theme.colors.text)
                                                                .mb_1()
                                                                .child(fav.label.clone())
                                                        )
                                                        .child(
                                                            div()
                                                                .text_xs()
                                                                .text_color(theme.colors.text_muted)
                                                                .max_w(px(350.0))
                                                                .overflow_hidden()
                                                                .child(if fav.text.len() > 100 {
                                                                    format!("{}...", &fav.text[..100])
                                                                } else {
                                                                    fav.text.clone()
                                                                })
                                                        )
                                                )
                                                .child(
                                                    div()
                                                        .flex()
                                                        .items_center()
                                                        .gap_2()
                                                        .child(
                                                            div()
                                                                .text_xs()
                                                                .text_color(theme.colors.text_muted)
                                                                .child(format!("√ó{}", fav.usage_count))
                                                        )
                                                        .child(
                                                            div()
                                                                .id(ElementId::Name(format!("del-fav-{}", fav.id).into()))
                                                                .px_1()
                                                                .rounded_sm()
                                                                .cursor_pointer()
                                                                .text_xs()
                                                                .text_color(theme.colors.text_muted)
                                                                .hover(|s| s.text_color(theme.colors.error))
                                                                .on_click(cx.listener(move |this, _, _window, cx| {
                                                                    this.remove_favorite(&fav_id_delete, cx);
                                                                }))
                                                                .child("√ó")
                                                        )
                                                )
                                        )
                                }))
                            })
                    )
            )
    }

}
